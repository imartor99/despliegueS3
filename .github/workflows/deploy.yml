name: CI/CD Despliegue Est√°tico S3

# El workflow se dispara en push a estas ramas
on:
  push:
    branches:
      - main
      - dev
      - 'feature/**' 

jobs:
  # 1. CI (Integraci√≥n Continua): Pruebas y Documentaci√≥n
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Instalar dependencias (Jest, JSDoc)
        run: npm install 

      - name: ‚úÖ Ejecutar Pruebas Unitarias (Tarea 2)
        run: npm test 

      - name: üìÑ Generar Documentaci√≥n (Tarea 3)
        run: npm run docs 

      - name: üì§ Subir Documentaci√≥n como Artefacto
        uses: actions/upload-artifact@v4
        with:
          name: documentacion-jsdoc
          path: out/
          
  # 2. CD (Despliegue Continuo): Despliegue a S3
  deploy:
    needs: ci # Solo se ejecuta si el job 'ci' ha pasado correctamente
    # Solo despliega si el push va a las ramas 'dev' o 'main'
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main' 
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar Credenciales de AWS (Con Token de Sesi√≥n)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Usamos los 5 Secrets configurados en GitHub
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }} # ¬°Necesario para AWS Academy!
          aws-region: ${{ secrets.AWS_REGION }}

      - name: üöÄ Desplegar a S3 (Sincronizaci√≥n)
        run: |
          echo "Iniciando despliegue de archivos est√°ticos a s3://${{ secrets.S3_BUCKET_NAME }}"
          # Sincroniza el directorio local con el bucket S3, excluyendo archivos de configuraci√≥n/pruebas/docs
          aws s3 sync . s3://${{ secrets.S3_BUCKET_NAME }} \
            --delete \
            --acl public-read \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "node_modules/*" \
            --exclude "out/*" \
            --exclude "*.test.js" \
            --exclude "package.json" \
            --exclude "package-lock.json"
          echo "Despliegue finalizado."